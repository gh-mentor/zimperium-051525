This code has a deadlock problem.

1) Identify the cause of the deadlock in the code.
2) Refactor the code to prevent the deadlock.
3) Test the code to ensure that it works correctly and does not deadlock.
